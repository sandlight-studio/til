# 学习总结（2025-09-24 00:00:00 – 2025-09-28 23:59:59）

## ✅ 本周期结论
本期围绕 **电商媒体/配置规范**、**后端工程与运维（SQL/MQ/JVM/构建）**、**工具与系统（IDEA/macOS）**、**概念辨析与常识（status/state、血型、信用提额）** 多线推进；已形成可落地的轮询与批量查询方案、Nacos 中 `Duration` 的正确写法、Metaspace 爆掉（OutOfMemoryError: Metaspace）排查路径，以及 Excel+图片读取的工程化做法。

---

## 📚 学习要点（按主题）

### 1) Shopify 媒体处理与状态轮询
- **轮询思路**：上传后以资源 `id` 批量查询 `media.status`（`PROCESSING/READY/FAILED`），采用**指数退避**（exponential backoff）降低压力。
- **批量查询**：使用 GraphQL `nodes(ids: [...]) { ... on MediaImage { id status mimeType } }` 或以 `files`/`media` 入口分页拉取并过滤状态。
- **一致性校验**：校对 **扩展名 vs 文件头**（Magic Number），避免“扩展名正确但内容非 JPEG/PNG”导致审核失败。

### 2) Nacos / Spring Boot `Duration` 配置
- **可用写法**：`500ms`、`30s`、`5m`、`2h` 或 ISO-8601 格式 `PT30S`；避免写成 `0.5s`（建议换算到 `ms`）。  
- **绑定位置**：放入 `*.yaml` 后由 Spring Boot Binder 自动绑定到 `java.time.Duration` 字段（例如 `MediaStatusConfig.pollInterval`）。

### 3) Java 导入 Excel 图片（EasyExcel/POI）
- **关键点**：开启图片额外读取（`extraRead(CellExtraTypeEnum.PICTURE)`），用监听器收集 `CellExtra`；图片坐标以**锚点**（anchor）记录，需与单元格/合并单元格映射。
- **垂直表+图片**：先解析**表头行/列坐标**→ 建立“单元格→业务字段”映射 → 再按锚点把图片归位；必要时二次遍历处理合并区域。
- **工程化避坑**：  
  - 流式读取 + 临时文件缓存，避免一次性加载导致 OOM；  
  - 去重规则（按坐标/哈希）与图片大小限制；  
  - 对图片落盘路径与清理机制做成可配置。

### 4) RabbitMQ / 任务配置与 xxl-job 认知
- **消费组与订阅**：一个 group 可以订阅多个 topic，但建议**按职责拆组**以隔离位点与幂等。  
- **xxl-job 配置辨识**：`admin.addresses`（调度中心地址）、`executor.appname/ip/port`（执行器标识与暴露端口）、`accessToken`（鉴权）、`logretentiondays`（日志保留）。  
- **配置优先级**：Nacos/`application*.yml` 高于代码硬编码，冗余的 `RabbitMQConfig` 可删除以避免冲突。

### 5) SQL：“超额推送”统计/清理（禁用 WITH 的场景）
- **两类规则合并**（用 `UNION`）：  
  1) **组内存在 `style_status=2`** → 仅删**非 2**且在时间窗内的记录；  
  2) **组内不存在 `style_status=2`** → **保留最早**，删其余（限时间窗内）。  

### 6) JVM Metaspace 调优与泄漏排查
- **应急参数**：`-XX:MaxMetaspaceSize=512m`（或更大）、`-XX:MetaspaceSize=256m`；仅止血，**不是根因处理**。  
- **根因路径**：关注**类加载器泄漏**（动态生成类、热加载、反射代理未释放）→ `jcmd VM.classloader_stats`、`jmap -clstats`、`jcmd GC.class_histogram` 辅助定位 → 修复不必要的类生成/缓存与 ClassLoader 引用。

### 7) Gradle 下载加速（Windows/IDEA）
- **`bin` vs `all`**：`all` 包含源码与文档（IDE 索引更顺滑），但更大；结合**镜像源**与**Wrapper 固定版本**提升稳定性。  
- **常见做法**：  
  - Maven 仓库设镜像（阿里/腾讯/公司 Nexus）；  
  - 预热本地缓存；必要时 `--offline`；  
  - IDEA 选择“**Use Gradle from 'gradle-wrapper'**”。

### 8) macOS 占用端口排查与端口切换
- **排查**：`lsof -iTCP:8080 -sTCP:LISTEN -n -P` → `kill -15 <pid>`（不行再 `kill -9`）。  
- **切换**：Spring Boot 以 `--server.port=8081`、`SERVER_PORT=8081` 或配置文件覆盖；避免在公司机上随意 `-9`。

### 9) Redisson 组件要点
- **锁语义**：可重入锁、**看门狗续期**（自动延长持锁 TTL），支持公平锁/读写锁；  
- **正确用法**：尽量用 `tryLock(timeout, leaseTime)` 指定租期，防止业务异常导致“长时间持锁”。  
- **替代权衡**：与 Lettuce/Jedis 相比，Redisson 提供更丰富的分布式结构（Map/DelayQueue/Bloom），但 Jar 体量更大。

### 10) 概念辨析：`status` vs `state`
- **state（状态机/内部态）**：系统当前内部**快照**，可细粒度且频繁变更；  
- **status（对外状态/进度）**：面向外部的**阶段性标识**（如 `PENDING/RUNNING/SUCCESS/FAILED`），更稳定、可追踪。

---

## 🛠️ 速用清单（Mini-Checklist）
- **媒体轮询**：`ids → nodes(...) → status`；退避 `1s → 2s → 4s...`，上限与超时兜底。  
- **Duration 配置**：`500ms`/`30s`/`1m` 或 `PT30S`；统一在 Nacos。  
- **Excel+图片**：启用图片读取、处理锚点与合并单元格、限制图片大小并落盘。  
- **Metaspace**：先止血参数，再查 ClassLoader 泄漏。  
- **SQL 清理**：`UNION` 组合两规则 + 软删 + 索引。  
- **端口占用**：`lsof` 定位、优先 `-15`，必要时改 `server.port`。  
- **Redisson 锁**：`tryLock(timeout, leaseTime)` + 业务内 finally 解锁。
